-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.api_usage_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  search_id uuid,
  provider text NOT NULL CHECK (provider = ANY (ARRAY['serper'::text, 'deepseek'::text, 'gemini'::text, 'openai'::text])),
  endpoint text,
  status integer,
  ms integer,
  tokens integer DEFAULT 0,
  cost_usd numeric DEFAULT 0,
  request jsonb DEFAULT '{}'::jsonb,
  response jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT api_usage_logs_pkey PRIMARY KEY (id),
  CONSTRAINT api_usage_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT api_usage_logs_search_id_fkey FOREIGN KEY (search_id) REFERENCES public.user_searches(id)
);
CREATE TABLE public.app_users (
  id uuid NOT NULL,
  email text NOT NULL,
  full_name text DEFAULT ''::text,
  company text DEFAULT ''::text,
  country text DEFAULT ''::text,
  phone text DEFAULT ''::text,
  role text NOT NULL DEFAULT 'user'::text CHECK (role = ANY (ARRAY['user'::text, 'admin'::text])),
  onboarding jsonb NOT NULL DEFAULT '{}'::jsonb,
  preferences jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  is_demo_user boolean NOT NULL DEFAULT false,
  CONSTRAINT app_users_pkey PRIMARY KEY (id),
  CONSTRAINT app_users_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);
CREATE TABLE public.business_personas (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  search_id uuid NOT NULL,
  user_id uuid NOT NULL,
  title text NOT NULL,
  rank integer NOT NULL,
  match_score integer NOT NULL,
  demographics jsonb DEFAULT '{}'::jsonb,
  characteristics jsonb DEFAULT '{}'::jsonb,
  behaviors jsonb DEFAULT '{}'::jsonb,
  market_potential jsonb DEFAULT '{}'::jsonb,
  locations jsonb DEFAULT '[]'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  embedding USER-DEFINED,
  embed USER-DEFINED,
  CONSTRAINT business_personas_pkey PRIMARY KEY (id),
  CONSTRAINT business_personas_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT business_personas_search_id_fkey FOREIGN KEY (search_id) REFERENCES public.user_searches(id)
);
CREATE TABLE public.businesses (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  search_id uuid NOT NULL,
  user_id uuid NOT NULL,
  persona_id uuid,
  name text NOT NULL,
  industry text NOT NULL,
  country text NOT NULL,
  city text,
  size text,
  revenue text,
  description text DEFAULT ''::text,
  match_score integer NOT NULL,
  relevant_departments ARRAY DEFAULT '{}'::text[],
  key_products ARRAY DEFAULT '{}'::text[],
  recent_activity ARRAY DEFAULT '{}'::text[],
  persona_type text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  email text DEFAULT ''::text,
  phone text DEFAULT ''::text,
  website text DEFAULT ''::text,
  address text DEFAULT ''::text,
  rating numeric DEFAULT NULL::numeric,
  embedding USER-DEFINED,
  embed USER-DEFINED,
  CONSTRAINT businesses_pkey PRIMARY KEY (id),
  CONSTRAINT businesses_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT businesses_persona_id_fkey FOREIGN KEY (persona_id) REFERENCES public.business_personas(id),
  CONSTRAINT businesses_search_id_fkey FOREIGN KEY (search_id) REFERENCES public.user_searches(id)
);
CREATE TABLE public.campaign_recipients (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  campaign_id uuid NOT NULL,
  user_id uuid NOT NULL,
  recipient_type text NOT NULL CHECK (recipient_type = ANY (ARRAY['business'::text, 'decision_maker'::text])),
  recipient_id uuid NOT NULL,
  recipient_name text NOT NULL,
  recipient_email text NOT NULL,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'sent'::text, 'opened'::text, 'clicked'::text, 'replied'::text])),
  sent_at timestamp with time zone,
  opened_at timestamp with time zone,
  clicked_at timestamp with time zone,
  replied_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT campaign_recipients_pkey PRIMARY KEY (id),
  CONSTRAINT campaign_recipients_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT campaign_recipients_campaign_id_fkey FOREIGN KEY (campaign_id) REFERENCES public.email_campaigns(id)
);
CREATE TABLE public.contact_enrichment_cache (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  person_name text NOT NULL,
  company_name text NOT NULL,
  enrichment_data jsonb NOT NULL,
  confidence_score integer DEFAULT 0,
  sources ARRAY DEFAULT ARRAY[]::text[],
  linkedin_profile_url text,
  emails jsonb DEFAULT '[]'::jsonb,
  last_enriched timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT contact_enrichment_cache_pkey PRIMARY KEY (id)
);
CREATE TABLE public.decision_maker_personas (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  search_id uuid NOT NULL,
  user_id uuid NOT NULL,
  title text NOT NULL,
  rank integer NOT NULL,
  match_score integer NOT NULL,
  demographics jsonb DEFAULT '{}'::jsonb,
  characteristics jsonb DEFAULT '{}'::jsonb,
  behaviors jsonb DEFAULT '{}'::jsonb,
  market_potential jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  embedding USER-DEFINED,
  CONSTRAINT decision_maker_personas_pkey PRIMARY KEY (id),
  CONSTRAINT decision_maker_personas_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT decision_maker_personas_search_id_fkey FOREIGN KEY (search_id) REFERENCES public.user_searches(id)
);
CREATE TABLE public.decision_makers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  search_id uuid NOT NULL,
  user_id uuid NOT NULL,
  persona_id uuid,
  name text NOT NULL,
  title text NOT NULL,
  level text NOT NULL CHECK (level = ANY (ARRAY['executive'::text, 'director'::text, 'manager'::text, 'individual'::text])),
  influence integer NOT NULL,
  department text NOT NULL,
  company text NOT NULL,
  location text NOT NULL,
  email text,
  phone text DEFAULT ''::text,
  linkedin text DEFAULT ''::text,
  experience text DEFAULT ''::text,
  communication_preference text DEFAULT ''::text,
  pain_points ARRAY DEFAULT '{}'::text[],
  motivations ARRAY DEFAULT '{}'::text[],
  decision_factors ARRAY DEFAULT '{}'::text[],
  persona_type text NOT NULL,
  company_context jsonb DEFAULT '{}'::jsonb,
  personalized_approach jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  match_score integer DEFAULT 75,
  enrichment_status USER-DEFINED NOT NULL DEFAULT 'pending'::enrichment_status_t,
  enrichment jsonb,
  business_id uuid,
  email_verification jsonb,
  enrichment_confidence numeric,
  enrichment_sources ARRAY DEFAULT '{}'::text[],
  linkedin_profile_data jsonb DEFAULT '{}'::jsonb,
  email_enrichment_data jsonb DEFAULT '{}'::jsonb,
  enrichment_metadata jsonb DEFAULT '{}'::jsonb,
  last_enriched timestamp with time zone,
  embedding USER-DEFINED,
  title_embed USER-DEFINED,
  CONSTRAINT decision_makers_pkey PRIMARY KEY (id),
  CONSTRAINT decision_makers_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT decision_makers_persona_id_fkey FOREIGN KEY (persona_id) REFERENCES public.decision_maker_personas(id),
  CONSTRAINT fk_decision_makers_business_id FOREIGN KEY (business_id) REFERENCES public.businesses(id),
  CONSTRAINT decision_makers_search_id_fkey FOREIGN KEY (search_id) REFERENCES public.user_searches(id)
);
CREATE TABLE public.email_campaigns (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  search_id uuid,
  user_id uuid NOT NULL,
  name text NOT NULL,
  campaign_type text NOT NULL CHECK (campaign_type = ANY (ARRAY['customer'::text, 'supplier'::text])),
  status text DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'scheduled'::text, 'sent'::text, 'active'::text])),
  template_id text,
  subject text NOT NULL,
  content text NOT NULL,
  scheduled_date timestamp with time zone,
  sent_date timestamp with time zone,
  stats jsonb DEFAULT '{"sent": 0, "opened": 0, "clicked": 0, "replied": 0}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_campaigns_pkey PRIMARY KEY (id),
  CONSTRAINT email_campaigns_search_id_fkey FOREIGN KEY (search_id) REFERENCES public.user_searches(id),
  CONSTRAINT email_campaigns_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.email_delivery_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  campaign_id uuid,
  recipient_emails ARRAY NOT NULL,
  provider_used text NOT NULL,
  message_id text,
  delivery_status text CHECK (delivery_status = ANY (ARRAY['sent'::text, 'queued'::text, 'failed'::text, 'bounced'::text, 'delivered'::text])),
  status_code integer,
  error_message text,
  webhook_data jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_delivery_logs_pkey PRIMARY KEY (id),
  CONSTRAINT email_delivery_logs_campaign_id_fkey FOREIGN KEY (campaign_id) REFERENCES public.email_campaigns(id)
);
CREATE TABLE public.idempotency_cache (
  key text NOT NULL,
  payload jsonb,
  ttl_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT idempotency_cache_pkey PRIMARY KEY (key)
);
CREATE TABLE public.job_tasks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  job_id uuid NOT NULL,
  name text NOT NULL,
  status text NOT NULL DEFAULT 'queued'::text,
  attempt integer NOT NULL DEFAULT 0,
  progress integer NOT NULL DEFAULT 0,
  idempotency_key text NOT NULL,
  error text,
  started_at timestamp with time zone,
  finished_at timestamp with time zone,
  CONSTRAINT job_tasks_pkey PRIMARY KEY (id),
  CONSTRAINT job_tasks_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id)
);
CREATE TABLE public.jobs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  type text NOT NULL,
  payload jsonb NOT NULL DEFAULT '{}'::jsonb,
  status text NOT NULL DEFAULT 'queued'::text,
  run_at timestamp with time zone NOT NULL DEFAULT now(),
  attempts integer NOT NULL DEFAULT 0,
  max_attempts integer NOT NULL DEFAULT 3,
  last_error text,
  claimed_by text,
  claimed_at timestamp with time zone,
  heartbeat_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT jobs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.linkedin_query_cache (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  search_id uuid,
  company text NOT NULL,
  query text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT linkedin_query_cache_pkey PRIMARY KEY (id)
);
CREATE TABLE public.market_insights (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  search_id uuid NOT NULL,
  user_id uuid NOT NULL,
  tam_data jsonb DEFAULT '{}'::jsonb,
  sam_data jsonb DEFAULT '{}'::jsonb,
  som_data jsonb DEFAULT '{}'::jsonb,
  competitor_data jsonb DEFAULT '[]'::jsonb,
  trends jsonb DEFAULT '[]'::jsonb,
  opportunities jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  sources jsonb DEFAULT '[]'::jsonb,
  analysis_summary text DEFAULT ''::text,
  research_methodology text DEFAULT ''::text,
  payload jsonb,
  CONSTRAINT market_insights_pkey PRIMARY KEY (id),
  CONSTRAINT market_insights_search_id_fkey FOREIGN KEY (search_id) REFERENCES public.user_searches(id),
  CONSTRAINT market_insights_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.response_cache (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  search_id uuid,
  cache_key text NOT NULL,
  source text NOT NULL CHECK (source = ANY (ARRAY['serper'::text, 'deepseek'::text, 'gemini'::text, 'google_places'::text, 'google_cse'::text])),
  response jsonb NOT NULL,
  ttl_at timestamp with time zone NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT response_cache_pkey PRIMARY KEY (id),
  CONSTRAINT response_cache_search_id_fkey FOREIGN KEY (search_id) REFERENCES public.user_searches(id),
  CONSTRAINT response_cache_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.search_cache (
  search_id uuid NOT NULL,
  businesses jsonb DEFAULT '[]'::jsonb,
  business_personas jsonb DEFAULT '[]'::jsonb,
  dm_personas jsonb DEFAULT '[]'::jsonb,
  decision_makers jsonb DEFAULT '[]'::jsonb,
  market_insights jsonb DEFAULT '[]'::jsonb,
  progress jsonb DEFAULT '{}'::jsonb,
  is_complete boolean DEFAULT false,
  last_updated timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT search_cache_pkey PRIMARY KEY (search_id),
  CONSTRAINT search_cache_search_id_fkey FOREIGN KEY (search_id) REFERENCES public.user_searches(id)
);
CREATE TABLE public.subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  provider text NOT NULL DEFAULT 'manual'::text CHECK (provider = ANY (ARRAY['stripe'::text, 'paddle'::text, 'manual'::text])),
  plan text NOT NULL DEFAULT 'free'::text CHECK (plan = ANY (ARRAY['free'::text, 'starter'::text, 'pro'::text, 'enterprise'::text, 'demo'::text])),
  status text NOT NULL DEFAULT 'incomplete'::text CHECK (status = ANY (ARRAY['incomplete'::text, 'trialing'::text, 'active'::text, 'past_due'::text, 'canceled'::text, 'paused'::text])),
  cancel_at_period_end boolean NOT NULL DEFAULT false,
  period_start timestamp with time zone,
  period_end timestamp with time zone,
  trial_end timestamp with time zone,
  seats integer NOT NULL DEFAULT 1,
  meta jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT subscriptions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.user_otps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  email text NOT NULL,
  purpose text NOT NULL CHECK (purpose = ANY (ARRAY['signup'::text, 'signin'::text])),
  code_hash text NOT NULL,
  expires_at timestamp with time zone NOT NULL,
  consumed_at timestamp with time zone,
  attempts integer NOT NULL DEFAULT 0,
  ip text,
  ua text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_otps_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_searches (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  search_type text NOT NULL CHECK (search_type = ANY (ARRAY['customer'::text, 'supplier'::text])),
  product_service text NOT NULL,
  industries ARRAY DEFAULT '{}'::text[],
  countries ARRAY DEFAULT '{}'::text[],
  status text DEFAULT 'in_progress'::text CHECK (status = ANY (ARRAY['in_progress'::text, 'completed'::text, 'failed'::text, 'cancelled'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  phase text DEFAULT 'starting'::text CHECK (phase = ANY (ARRAY['starting'::text, 'business_discovery'::text, 'business_personas'::text, 'dm_personas'::text, 'decision_makers'::text, 'market_research'::text, 'completed'::text, 'failed'::text])),
  progress_pct integer DEFAULT 0,
  error jsonb DEFAULT '{}'::jsonb,
  totals jsonb DEFAULT '{}'::jsonb,
  current_phase text DEFAULT 'starting'::text,
  CONSTRAINT user_searches_pkey PRIMARY KEY (id),
  CONSTRAINT user_searches_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);